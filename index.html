<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Apresiasi & Stok (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .timestamp { font-size: 0.75rem; color: #9ca3af; }
        .tab-button.active { background-color: #3b82f6; color: white; }
        td input, td select {
            background-color: #4b5563; border: 1px solid #6b7280;
            border-radius: 0.375rem; padding: 0.25rem 0.5rem;
            width: 100%; font-size: 0.875rem;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%;
            margin-left: -20px; margin-top: -20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .readonly-row { background-color: #374151 !important; color: #9ca3af; }
        .readonly-row input, .readonly-row select, .readonly-row button { pointer-events: none; opacity: 0.7; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-gray-200">

    <!-- HALAMAN LOGIN -->
    <div id="login-page" class="min-h-screen flex items-center justify-center bg-gray-900 px-4">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Login Aplikasi</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-400 mb-2">Email</label>
                    <input type="email" id="username" class="w-full bg-gray-700 p-3 rounded-lg" placeholder="admin@apresiasi.com" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-400 mb-2">Password</label>
                    <input type="password" id="password" class="w-full bg-gray-700 p-3 rounded-lg" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 rounded-lg">Login</button>
                <p id="login-error" class="text-red-500 text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>

    <!-- HALAMAN APLIKASI UTAMA -->
    <div id="app-page" class="hidden">
        <div class="sticky top-0 z-10 bg-gray-900">
            <header class="bg-gray-800 shadow-md p-4 flex justify-between items-center gap-4">
                <h1 class="text-xl font-bold text-white flex-shrink-0">Aplikasi Apresiasi & Stok</h1>
                <div class="flex items-center gap-4 w-full justify-end">
                    <input type="text" id="search-input" placeholder="Cari Nama atau Item..." class="w-full max-w-xs bg-gray-700 p-2 rounded-lg text-sm text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 font-semibold py-2 px-4 rounded-lg text-sm flex-shrink-0">Logout</button>
                </div>
            </header>
            <div class="px-4 sm:px-6 pt-4 border-b border-gray-700">
                <div id="tab-container" class="flex flex-wrap gap-2"></div>
            </div>
            <div id="form-container" class="p-4 sm:p-6 bg-gray-800 border-b border-gray-700"></div>
        </div>

        <main class="p-4 sm:p-6">
            <h2 id="table-title" class="text-2xl font-bold mb-4 text-white"></h2>
            <div id="table-container" class="bg-gray-800 rounded-xl shadow-lg overflow-x-auto relative min-h-[200px]">
                <div id="table-loader" class="loader hidden"></div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // KUNCI FIREBASE ANDA SUDAH SAYA PASANG DI SINI
        const firebaseConfig = {
            apiKey: "AIzaSyAF8eA2mPosZJMn-eW-binsEjHFawoE9u0",
            authDomain: "aplikasi-apresiasi-sales.firebaseapp.com",
            projectId: "aplikasi-apresiasi-sales",
            storageBucket: "aplikasi-apresiasi-sales.firebasestorage.app",
            messagingSenderId: "575335509809",
            appId: "1:575335509809:web:13e23de2aedf6ee6964a10",
            measurementId: "G-WG6P1PN9VB"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        document.addEventListener('DOMContentLoaded', () => {
            let localData = {};
            let activeTab = 'kd10';
            let listeners = {}; 
            let searchTerm = '';

            const legacyOfflineData = [
                { id: "KDO1", name: "TOTOK", hadiah: "kaos polos", tipe: "LOYAL" }, { id: "KDO2", name: "Kak Deddy", hadiah: "Jersey fullprint", tipe: "LOYAL" },
                { id: "KDO3", name: "Arelano", hadiah: "Tas serut", tipe: "BARU" }, { id: "KDO4", name: "Audi", hadiah: "Kaos Polos", tipe: "LOYAL" },
                { id: "KDO5", name: "Fauzan", hadiah: "Jersey fullprint", tipe: "BARU" }, { id: "KDO6", name: "putri", hadiah: "DTF", tipe: "BARU" },
                { id: "KDO7", name: "cilya", hadiah: "DTF", tipe: "BARU" }, { id: "KDO8", name: "Arya", hadiah: "Buku tulis", tipe: "BARU" },
                { id: "KDO9", name: "Laras", hadiah: "Tas serut", tipe: "BARU" }, { id: "KDO10", name: "Dyas", hadiah: "Jersey fullprint", tipe: "LOYAL" },
                { id: "KDO11", name: "Pradi", hadiah: "buku tulis", tipe: "BARU" }, { id: "KDO12", name: "Pak Mega", hadiah: "Jersey fullprint", tipe: "LOYAL" },
                { id: "KDO13", name: "BINAR", hadiah: "Jersey fullprint", tipe: "LOYAL" }, { id: "KDO14", name: "joshua", hadiah: "buku tulis", tipe: "BARU" },
                { id: "KDO15", name: "ken", hadiah: "buku tulis", tipe: "BARU" }, { id: "KDO16", name: "fajar", hadiah: "tas serut", tipe: "BARU" },
                { id: "KDO17", name: "dwipa", hadiah: "tas serut", tipe: "BARU" }, { id: "KDO18", name: "aditya", hadiah: "tas serut", tipe: "BARU" },
                { id: "KDO19", name: "jose", hadiah: "DTF", tipe: "BARU" },
            ];

            const tabConfig = {
                'kd10': { title: 'KD_10', type: 'promo-kd', prefix: 'KD10' }, 'kd15': { title: 'KD_15', type: 'promo-kd', prefix: 'KD15' },
                'kd20': { title: 'KD_20', type: 'promo-kd', prefix: 'KD20' }, 'free': { title: '6 FREE 1', type: 'promo-simple', prefix: 'FR' },
                'offline': { title: 'OFFLINE', type: 'promo-offline', prefix: 'KDO' }, 'stokBaru': { title: 'STOK HADIAH BARU', type: 'stok' },
                'stokLoyal': { title: 'STOK HADIAH LOYAL', type: 'stok' }
            };

            const loginPage = document.getElementById('login-page');
            const appPage = document.getElementById('app-page');
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-button');
            const tableContainer = document.getElementById('table-container');
            const formContainer = document.getElementById('form-container');
            const tabContainer = document.getElementById('tab-container');
            const tableTitle = document.getElementById('table-title');
            const tableLoader = document.getElementById('table-loader');
            const searchInput = document.getElementById('search-input');

            function showLoader() { tableLoader.classList.remove('hidden'); }
            function hideLoader() { tableLoader.classList.add('hidden'); }
            function formatTimestamp(ts) { return ts ? new Date(ts.seconds * 1000).toLocaleString('id-ID', { hour12: false, day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }).replace(/\./g, ':') : ''; }
            
            auth.onAuthStateChanged(user => {
                if (user) {
                    loginPage.classList.add('hidden');
                    appPage.classList.remove('hidden');
                    initApp();
                } else {
                    appPage.classList.add('hidden');
                    loginPage.classList.remove('hidden');
                    Object.values(listeners).forEach(unsubscribe => unsubscribe());
                    listeners = {};
                }
            });

            function initApp() {
                tabContainer.innerHTML = Object.keys(tabConfig).map(key => `<button data-tab="${key}" class="tab-button py-2 px-4 font-semibold text-gray-400 hover:bg-gray-700 rounded-lg">${tabConfig[key].title}</button>`).join('');
                tabContainer.querySelector(`[data-tab="${activeTab}"]`).classList.add('active');
                Object.keys(tabConfig).forEach(tabName => setupRealtimeListener(tabName));
            }

            function setupRealtimeListener(tabName) {
                if (listeners[tabName]) listeners[tabName]();
                listeners[tabName] = db.collection(tabName).onSnapshot(snapshot => {
                    let docs = snapshot.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
                    if (tabConfig[tabName]?.type.startsWith('promo')) {
                        docs.sort((a, b) => (parseInt((a.id.match(/\d+$/) || ['0'])[0], 10) || 0) - (parseInt((b.id.match(/\d+$/) || ['0'])[0], 10) || 0));
                    } else if (tabConfig[tabName]?.type === 'stok') {
                        docs.sort((a, b) => a.item.localeCompare(b.item));
                    }
                    localData[tabName] = docs;
                    if (tabName === activeTab) render();
                    if(!localData.stokBaru || !localData.stokLoyal) showLoader(); else hideLoader();
                }, error => {
                    console.error("Error fetching data: ", error);
                    hideLoader();
                });
            }

            function render() {
                const config = tabConfig[activeTab];
                if (!config) return;
                tableTitle.textContent = `Data ${config.title}`;
                if (config.type !== 'promo-offline' && !localData[activeTab]) { showLoader(); return; }

                switch (config.type) {
                    case 'promo-kd': renderPromoTable(false); renderPromoForm(); break;
                    case 'promo-hadiah': renderPromoTable(true); renderPromoForm(); break;
                    case 'promo-simple': renderPromoTableSimple(); renderPromoForm(); break;
                    case 'promo-offline': renderOfflineTable(); renderOfflineForm(); break;
                    case 'stok': renderStockTable(); renderStockForm(); break;
                }
            }
            
            function renderPromoTable(withHadiah) {
                let data = localData[activeTab] || [];
                if (searchTerm) {
                    data = data.filter(item => (item.name && item.name.toLowerCase().includes(searchTerm)) || (item.id && item.id.toLowerCase().includes(searchTerm)));
                }
                let headers = ['NO', 'ITEM', 'NAMA', 'NO WA'];
                if (withHadiah) headers.push('HADIAH', 'TIPE');
                headers.push('PROMO KELUAR', 'CHECK', 'KLAIM', 'CHECK', 'AKSI');
                let tableHTML = `<table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr>${headers.map(h => `<th class="px-4 py-3 ${['NO', 'CHECK', 'AKSI'].includes(h) ? 'text-center' : ''}">${h}</th>`).join('')}</tr></thead><tbody>`;
                if (data.length === 0) { tableHTML += `<tr><td colspan="${headers.length}" class="text-center py-8">Tidak ada data ditemukan.</td></tr>`; }
                else {
                    data.forEach((item, index) => {
                        let rowContent = `<td class="px-4 py-2 text-center">${index + 1}</td><td class="px-4 py-2">${item.id}</td><td><input type="text" data-field="name" value="${item.name || ''}" class="bg-transparent"></td><td><input type="text" data-field="wa" value="${item.wa || ''}" class="bg-transparent"></td>`;
                        if (withHadiah) {
                            const stokList = (item.tipe === 'LOYAL' ? (localData.stokLoyal || []) : (localData.stokBaru || []));
                            const hadiahOptions = stokList.map(s => `<option value="${s.item}" ${s.item === item.hadiah ? 'selected' : ''}>${s.item}</option>`).join('');
                            rowContent += `<td><select data-field="hadiah"><option value="">-- Pilih --</option>${hadiahOptions}</select></td><td><select data-field="tipe"><option value="BARU" ${item.tipe === 'BARU' ? 'selected' : ''}>BARU</option><option value="LOYAL" ${item.tipe === 'LOYAL' ? 'selected' : ''}>LOYAL</option></select></td>`;
                        }
                        rowContent += `<td class="px-4 py-2 timestamp">${formatTimestamp(item.promoTimestamp)}</td><td class="px-4 py-2 text-center"><input type="checkbox" data-field="promoChecked" ${item.promoChecked ? 'checked' : ''}></td><td class="px-4 py-2 timestamp">${formatTimestamp(item.klaimTimestamp)}</td><td class="px-4 py-2 text-center"><input type="checkbox" data-field="klaimChecked" ${item.klaimChecked ? 'checked' : ''}></td><td class="px-4 py-2 text-center"><button class="delete-button bg-red-600 p-2 rounded-lg text-xs">Hapus</button></td>`;
                        tableHTML += `<tr class="border-b border-gray-700" data-doc-id="${item.docId}">${rowContent}</tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            }
            
            function renderPromoTableSimple() {
                let data = localData[activeTab] || [];
                if (searchTerm) {
                    data = data.filter(item => (item.name && item.name.toLowerCase().includes(searchTerm)) || (item.id && item.id.toLowerCase().includes(searchTerm)));
                }
                const headers = ['NO', 'ITEM', 'NAMA', 'NO WA', 'CHECK', 'AKSI'];
                let tableHTML = `<table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr>${headers.map(h => `<th class="px-4 py-3 ${['NO', 'CHECK', 'AKSI'].includes(h) ? 'text-center' : ''}">${h}</th>`).join('')}</tr></thead><tbody>`;
                if (data.length === 0) { tableHTML += `<tr><td colspan="${headers.length}" class="text-center py-8">Tidak ada data ditemukan.</td></tr>`; }
                else {
                    data.forEach((item, index) => {
                        tableHTML += `<tr class="border-b border-gray-700" data-doc-id="${item.docId}">
                            <td class="px-4 py-2 text-center">${index + 1}</td><td class="px-4 py-2">${item.id}</td>
                            <td><input type="text" data-field="name" value="${item.name || ''}" class="bg-transparent"></td>
                            <td><input type="text" data-field="wa" value="${item.wa || ''}" class="bg-transparent"></td>
                            <td class="px-4 py-2 text-center"><input type="checkbox" data-field="promoChecked" ${item.promoChecked ? 'checked' : ''}></td>
                            <td class="px-4 py-2 text-center"><button class="delete-button bg-red-600 p-2 rounded-lg text-xs">Hapus</button></td></tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            }

            function renderStockTable() {
                let data = localData[activeTab] || [];
                if (searchTerm) {
                    data = data.filter(item => item.item && item.item.toLowerCase().includes(searchTerm));
                }
                const headers = ['NO', 'ITEM', 'STOK AWAL', 'STOK KELUAR', 'STOK TERSEDIA', 'AKSI'];
                let tableHTML = `<table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr>${headers.map(h => `<th class="px-4 py-3 ${h === 'NO' || h === 'AKSI' ? 'text-center' : ''}">${h}</th>`).join('')}</tr></thead><tbody>`;
                if (data.length === 0) { tableHTML += `<tr><td colspan="${headers.length}" class="text-center py-8">Tidak ada data ditemukan.</td></tr>`; }
                else {
                    data.forEach((item, index) => {
                        const tersedia = (item.awal || 0) - (item.keluar || 0);
                        tableHTML += `<tr class="border-b border-gray-700" data-doc-id="${item.docId}">
                            <td class="px-4 py-2 text-center">${index + 1}</td><td class="px-4 py-2">${item.item}</td>
                            <td class="px-4 py-2">${item.awal}</td>
                            <td><input type="number" data-field="keluar" value="${item.keluar || 0}" class="w-24"></td>
                            <td class="px-4 py-2 font-bold">${tersedia}</td>
                            <td class="px-4 py-2 text-center"><button class="delete-button bg-red-600 p-2 rounded-lg text-xs">Hapus</button></td></tr>`;
                    });
                }
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            }
            
            function renderOfflineTable() {
                const dataFirebase = localData.offline || [];
                let allData = [...legacyOfflineData, ...dataFirebase];
                if (searchTerm) {
                    allData = allData.filter(item => (item.name && item.name.toLowerCase().includes(searchTerm)) || (item.id && item.id.toLowerCase().includes(searchTerm)));
                }
                let headers = ['NO', 'ITEM', 'NAMA', 'HADIAH', 'TIPE', 'AKSI'];
                let tableHTML = `<table class="w-full text-sm text-left text-gray-300"><thead class="text-xs text-gray-400 uppercase bg-gray-700 sticky top-0"><tr>${headers.map(h => `<th class="px-4 py-3 ${['NO', 'AKSI'].includes(h) ? 'text-center' : ''}">${h}</th>`).join('')}</tr></thead><tbody>`;
                allData.forEach((item, index) => {
                    const isLegacy = !item.docId;
                    tableHTML += `<tr class="${isLegacy ? 'readonly-row' : ''} border-b border-gray-700" data-doc-id="${item.docId || ''}">
                        <td class="px-4 py-2 text-center">${index + 1}</td><td class="px-4 py-2">${item.id}</td>
                        <td class="px-4 py-2">${isLegacy ? item.name : `<input type="text" data-field="name" value="${item.name || ''}" class="bg-transparent w-full">`}</td>
                        <td class="px-4 py-2">${item.hadiah}</td><td class="px-4 py-2">${item.tipe}</td>
                        <td class="px-4 py-2 text-center">${!isLegacy ? `<button class="delete-button bg-red-600 p-2 rounded-lg text-xs">Hapus</button>` : '<span>-</span>'}</td></tr>`;
                });
                tableHTML += `</tbody></table>`;
                tableContainer.innerHTML = tableHTML;
            }

            function getNextId() {
                const config = tabConfig[activeTab];
                const data = localData[activeTab] || [];
                let nextNumber = data.length + 1;
                if (activeTab === 'offline') {
                    nextNumber += legacyOfflineData.length;
                }
                return config.prefix + nextNumber;
            }
            
            function renderPromoForm() {
                const config = tabConfig[activeTab];
                const type = config.type;
                
                let formHTML = `<h3 class="text-lg font-semibold mb-4">Tambah Data Baru</h3><form id="add-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                        <input type="text" id="newItem" class="bg-gray-500 p-2 rounded" value="${getNextId()}" readonly>
                        <input type="text" id="newName" placeholder="NAMA" class="bg-gray-700 p-2 rounded" required>
                        <input type="text" id="newWa" placeholder="NO WA" class="bg-gray-700 p-2 rounded" required>`;
                
                if (type === 'promo-hadiah') {
                    formHTML = `<h3 class="text-lg font-semibold mb-4">Tambah Data Baru</h3><form id="add-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                        <input type="text" id="newItem" class="bg-gray-500 p-2 rounded" value="${getNextId()}" readonly>
                        <input type="text" id="newName" placeholder="NAMA" class="bg-gray-700 p-2 rounded" required>
                        <input type="text" id="newWa" placeholder="NO WA" class="bg-gray-700 p-2 rounded" required>
                        <select id="newTipe" class="bg-gray-700 p-2 rounded"><option value="BARU">BARU</option><option value="LOYAL">LOYAL</option></select>
                        <select id="newHadiah" class="bg-gray-700 p-2 rounded"></select>`;
                }

                formHTML += `<button type="submit" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded">Tambah</button></form>`;
                formContainer.innerHTML = formHTML;

                if (type === 'promo-hadiah') {
                    const tipeSelect = document.getElementById('newTipe');
                    const hadiahSelect = document.getElementById('newHadiah');
                    const updateHadiahOptions = () => {
                        const stokList = tipeSelect.value === 'LOYAL' ? (localData.stokLoyal || []) : (localData.stokBaru || []);
                        hadiahSelect.innerHTML = stokList.map(i => `<option value="${i.item}">${i.item}</option>`).join('');
                    };
                    tipeSelect.addEventListener('change', updateHadiahOptions);
                    if (localData.stokBaru || localData.stokLoyal) updateHadiahOptions();
                }
            }
            
            function renderOfflineForm() {
                const nextItemId = getNextId();
                let formHTML = `<h3 class="text-lg font-semibold mb-4">Tambah Data Baru</h3><form id="add-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                        <input type="text" id="newItem" class="bg-gray-500 p-2 rounded" value="${nextItemId}" readonly>
                        <input type="text" id="newName" placeholder="NAMA" class="bg-gray-700 p-2 rounded" required>
                        <select id="newTipe" class="bg-gray-700 p-2 rounded"><option value="BARU">BARU</option><option value="LOYAL">LOYAL</option></select>
                        <select id="newHadiah" class="bg-gray-700 p-2 rounded"></select>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded">Tambah & Kurangi Stok</button></form>`;
                formContainer.innerHTML = formHTML;
                const tipeSelect = document.getElementById('newTipe');
                const hadiahSelect = document.getElementById('newHadiah');
                const updateHadiahOptions = () => {
                    const stokList = tipeSelect.value === 'LOYAL' ? (localData.stokLoyal || []) : (localData.stokBaru || []);
                    hadiahSelect.innerHTML = stokList.map(i => `<option value="${i.item}">${i.item}</option>`).join('');
                };
                tipeSelect.addEventListener('change', updateHadiahOptions);
                if (localData.stokBaru || localData.stokLoyal) updateHadiahOptions();
            }

            function renderStockForm() {
                formContainer.innerHTML = `<h3 class="text-lg font-semibold mb-4">Tambah Item Stok Baru</h3><form id="add-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input type="text" id="newItemName" placeholder="Nama Item" class="bg-gray-700 p-2 rounded" required>
                    <input type="number" id="newStokAwal" placeholder="Stok Awal" class="bg-gray-700 p-2 rounded" required>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded">Tambah</button></form>`;
            }

            async function updateStok(itemName, tipe, amount) {
                if (!itemName || !tipe) return;
                const stokCollection = tipe === 'LOYAL' ? 'stokLoyal' : 'stokBaru';
                const q = db.collection(stokCollection).where("item", "==", itemName);
                try {
                    const querySnapshot = await q.get();
                    if (!querySnapshot.empty) {
                        const doc = querySnapshot.docs[0];
                        await doc.ref.update({ keluar: firebase.firestore.FieldValue.increment(amount) });
                    }
                } catch (error) { console.error("Error updating stock: ", error); }
            }

            loginForm.addEventListener('submit', e => { e.preventDefault(); auth.signInWithEmailAndPassword(username.value, password.value).catch(err => { loginError.textContent = "Email atau password salah."; loginError.classList.remove('hidden'); }); });
            logoutButton.addEventListener('click', () => auth.signOut());
            
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                render();
            });

            tabContainer.addEventListener('click', e => { if (e.target.matches('.tab-button')) { activeTab = e.target.dataset.tab; document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active')); e.target.classList.add('active'); render(); } });
            
            formContainer.addEventListener('submit', async e => {
                e.preventDefault();
                const config = tabConfig[activeTab];
                try {
                    if (config.type === 'promo-offline') {
                        const newItem = { id: document.getElementById('newItem').value, name: document.getElementById('newName').value, tipe: document.getElementById('newTipe').value, hadiah: document.getElementById('newHadiah').value };
                        if (!newItem.hadiah) { alert("Pilih hadiah."); return; }
                        await db.collection(activeTab).add(newItem);
                        await updateStok(newItem.hadiah, newItem.tipe, 1);
                    } else if (config.type.startsWith('promo')) {
                        const newItem = { id: document.getElementById('newItem').value, name: document.getElementById('newName').value, wa: document.getElementById('newWa').value, promoTimestamp: null, promoChecked: false, klaimTimestamp: null, klaimChecked: false };
                        if (config.type === 'promo-hadiah') { newItem.hadiah = document.getElementById('newHadiah').value || null; newItem.tipe = document.getElementById('newTipe').value; }
                        await db.collection(activeTab).add(newItem);
                    } else if (config.type === 'stok') {
                        await db.collection(activeTab).add({ item: document.getElementById('newItemName').value, awal: parseInt(document.getElementById('newStokAwal').value) || 0, keluar: 0 });
                    }
                    e.target.reset();
                } catch (error) { console.error("Error adding doc:", error); alert("Gagal menambah data."); }
            });
            
            tableContainer.addEventListener('change', async e => {
                const target = e.target;
                const docId = target.closest('tr').dataset.docId;
                if (!docId) return;
                const field = target.dataset.field;
                let value = target.type === 'checkbox' ? target.checked : (target.type === 'number' ? parseInt(target.value) || 0 : target.value);
                try {
                    let updateData = { [field]: value };
                    if (target.type === 'checkbox' && (field === 'promoChecked' || field === 'klaimChecked')) {
                        const tsField = field === 'promoChecked' ? 'promoTimestamp' : 'klaimTimestamp';
                        updateData[tsField] = value ? firebase.firestore.FieldValue.serverTimestamp() : null;
                    }
                    await db.collection(activeTab).doc(docId).update(updateData);
                } catch (error) { console.error("Error updating doc:", error); alert("Gagal memperbarui data."); }
            });

            tableContainer.addEventListener('click', async e => {
                const target = e.target.closest('.delete-button');
                if (target) {
                    const docId = target.closest('tr').dataset.docId;
                    if (!docId) return;
                    const itemToDelete = localData[activeTab].find(item => item.docId === docId);
                    if (itemToDelete && confirm('Anda yakin ingin menghapus item ini?')) {
                        try {
                            await db.collection(activeTab).doc(docId).delete();
                            if (activeTab === 'offline') {
                                await updateStok(itemToDelete.hadiah, itemToDelete.tipe, -1);
                            }
                        } catch(error) { console.error("Error removing doc:", error); alert("Gagal menghapus data."); }
                    }
                }
            });
        });
    </script>
</body>
</html>

